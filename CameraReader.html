<!DOCTYPE html>
<meta charset=utf-8>
<html lang="en">
	<head>
		<title>BarcodeReader</title>
		<script type="text/javascript" src="camera.js"></script>
	</head>
	<body>  
		<div id="container">
			<img width="320" height="240" src="about:blank" alt="" id="picture">
			<img width="320" height="240" src="about:blank" alt="" id="camera">
			<input id="Take-Picture" type="file" accept="image/*;capture=camera" />
			<p id="textbit"></p>
		</div>
		<script type="text/javascript">
			camera.init({
			    width: 160, // default: 640
			    height: 120, // default: 480
			    fps: 30, // default: 30
			    mirror: true,  // default: false
			    targetCanvas: document.getElementById('camera'), // default: null 

			    onFrame: function(canvas) {
			        // do something with image data found in the canvas argument
			        DecodeWorker.postMessage({ImageData: ctx.getImageData(0,0,canvas.width,canvas.height).data, Width: canvas.width, Height: canvas.height, cmd: "normal"});
			    },

			    onSuccess: function() {
			        // stream succesfully started, yay!
			    },

			    onError: function(error) {
			        // something went wrong on initialization
			    },

			    onNotSupported: function() {
			        // instruct the user to get a better browser
			    }
			});




			var takePicture = document.querySelector("#Take-Picture"),
			showPicture = document.querySelector("#picture");
			Result = document.querySelector("#textbit");
			Canvas = document.createElement("canvas");
			Canvas.width=640;
			Canvas.height=480;
			var resultArray = [];
			ctx = Canvas.getContext("2d");
			var workerCount = 0;
			function receiveMessage(e) {
				if(e.data.success === "log") {
					console.log(e.data.result);
					return;
				}
				if(e.data.finished) {
					workerCount--;
					if(workerCount) {
						if(resultArray.length == 0) {
							DecodeWorker.postMessage({ImageData: ctx.getImageData(0,0,Canvas.width,Canvas.height).data, Width: Canvas.width, Height: Canvas.height, cmd: "flip"});
						} else {
							workerCount--;
						}
					}
				}
				if(e.data.success){
					var tempArray = e.data.result;
					for(var i = 0; i < tempArray.length; i++) {
						if(resultArray.indexOf(tempArray[i]) == -1) {
							resultArray.push(tempArray[i]);
						}
					}
					Result.innerHTML=resultArray.join("<br />");
				}else{
					if(resultArray.length === 0 && workerCount === 0) {
						Result.innerHTML="Decoding failed.";
					}
				}
			}
			var DecodeWorker = new Worker("DecoderWorker.js");
			DecodeWorker.onmessage = receiveMessage;
			if(takePicture && showPicture) {
				takePicture.onchange = function (event) {
					var files = event.target.files
					if (files && files.length > 0) {
						file = files[0];
						try {
							var URL = window.URL || window.webkitURL;
							var imgURL = URL.createObjectURL(file);
							showPicture.src = imgURL;
							URL.revokeObjectURL(imgURL);
							DecodeBar()
						}
						catch (e) {
							try {
								var fileReader = new FileReader();
								fileReader.onload = function (event) {
									showPicture.src = event.target.result;
								};
								fileReader.readAsDataURL(file);
								DecodeBar()
							}
							catch (e) {
								Result.innerHTML = "Neither createObjectURL or FileReader are supported";
							}
						}
					}
				};
			}
			function DecodeBar(){
				showPicture.onload = function(){
					ctx.drawImage(showPicture,0,0,Canvas.width,Canvas.height);
					resultArray = [];
					workerCount = 2;
					Result.innerHTML="";
					DecodeWorker.postMessage({ImageData: ctx.getImageData(0,0,Canvas.width,Canvas.height).data, Width: Canvas.width, Height: Canvas.height, cmd: "normal"});
				}
			}
		</script>
	</body>
</html>
					
